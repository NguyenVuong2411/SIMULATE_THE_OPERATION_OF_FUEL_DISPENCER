#include <nhap.h>
#include<keypadcode.c>

#define lcd_enable_pin  PIN_E2
#define lcd_rs_pin      PIN_E0      
#define lcd_rw_pin      PIN_E1
#define lcd_data4       PIN_D4
#define lcd_data5       PIN_D5
#define lcd_data6       PIN_D6
#define lcd_data7       PIN_D7

 // KHAI BÁO BIEN//~~

UNSIGNED INT8 CHUOI1[] = {"                "};

UNSIGNED INT16 a1, a2,   m, k;
float a,b,c,d, f,  LIT, tien ;

UNSIGNED INT16 m1;

UNSIGNED INT8 CHUOI2[] = {"                "};
   ///// CHUONG TRINH NGAT////////
#INT_EXT
void  EXT_isr(void) 
{ k=k+1;
   if (k<d){
  LIT = LIT + 0.00225;
  tien = tien + b*0.00225;
  output_bit(PIN_A0, 1);
   clear_interrupt(INT_EXT); }
 
  else  {
  output_bit(PIN_A0, 0); 
  clear_interrupt(INT_EXT);}
 }
 
 
                
#include <lcd.c>

 //CHUONG TRINH CHINH//~~
void main()
{ 
   set_tris_B(0x0F); // B input
   set_tris_D(0);    // D output
   set_tris_E(0);    // E output
   set_tris_A(0);
   output_bit(PIN_A0, 1);
   enable_interrupts(INT_EXT);      // ngat ngoai
   enable_interrupts(GLOBAL);  // ngat toan cuc
   ext_int_edge(H_TO_L);  
   lcd_init(); 
   
    LAP:
      
   KEY_4X4();
   if(MP!=0x0FF)
   {
      if(MP<11) 
         {   m = m++;
             f = f*(10^(m)) + MP;
             c = f/b;
             d = c/(2.25e-3);
           
         for(a1=0; a1<16; a1++)
            {
               CHUOI1[a1]=CHUOI1[a1+1];
               
               }
           
               CHUOI1[15]=MP+0x30;
               
      /////////////////////
               lcd_gotoxy(21,1);
               for (a1=0; a1<16; a1++)
               {lcd_putc(CHUOI1[a1]);
               }
             
               }
          else if(MP==50)
          { 
          
          lcd_gotoxy(31,1);
            printf(lcd_putc,"50000");
             a = 50000;
             c = a/b;
             d = c/(2.25e-3);
             
                  }
          else if (MP==20)
          { 
           lcd_gotoxy(31,1);
            printf(lcd_putc,"20000");
             a = 20000;
             c = a/b;
             d = c/(2.25e-3);
          
             
          }
          
                  
          else if (MP==100)
          { 
           lcd_gotoxy(31,1);
            printf(lcd_putc,"100000");
             a = 100000;
             c = a/b;
             d = c/(2.25e-3);
           
             
          }
          
          
          
           else if (MP==22)
          {   c = 0;
                d = m = f = 0 ;
          tien = 0;
          k = LIT = 0;
            
            output_bit(PIN_A0, 1);
          lcd_gotoxy(31,1);
               for (a1=0; a1<16; a1++)
               {CHUOI1[a1]= 0x01;
             
               lcd_putc(CHUOI1[a1]);
            
               }
          } 
          
          else if (MP ==23) 
          {   NE:  
             KEY_4X4();
   if(MP!=0x0FF)
   {
      if(MP<11) 
         {   m1 = m1++;
             b = b*(10^(m1)) + MP;
             
           
         for(a2=0; a2<16; a2++)
            {
               CHUOI2[a2]=CHUOI2[a2+1];
               
               }
           
               CHUOI2[15]=MP+0x30;
               
      /////////////////////
               lcd_gotoxy(21,2);
               for (a2=0; a2<16; a2++)
               {lcd_putc(CHUOI2[a2]);
               }
             
               }
               else if (MP == 23)
              
               { goto LAP; }
               
               
               
               }goto NE; }
               
               else if (MP == 24)
               {m1 =0;
                b = 0; 
                 lcd_gotoxy(21,2);
               for (a2=0; a2<16; a2++)
               {CHUOI2[a2]= 0x01;
             
               lcd_putc(CHUOI2[a2]);
              
               }
             
                }
          
          
          
       }
                  
      lcd_gotoxy(1,1);                          // dong 1, cot 1 LCD
      printf(lcd_putc,"SO TIEN: %0.3f", tien);  // hien thi tong tien
      lcd_gotoxy(1,2);                          // dong 2, cot 1 LCD
      printf(lcd_putc,"SO LIT: %0.3f ", LIT);   // hien thi so lit xang  
      lcd_gotoxy(21,2);                         // dong 2, cot 1 LCD
      printf(lcd_putc,"DON GIA: ");    
      lcd_gotoxy(21,1);                         // dong 2, cot 1 LCD
      printf(lcd_putc,"CHON GIA:");   
                  goto LAP;
                 
              
                  }
                  
                  
                
                  
 
 
                  
                  
